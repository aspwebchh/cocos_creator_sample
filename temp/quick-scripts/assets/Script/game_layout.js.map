{"version":3,"sources":["game_layout.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"..\\..\\..\\..\\assets\\Script","sourcesContent":["import ItemWrapper from \"./item_wrapper\";\r\n\r\n// Learn TypeScript:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/typescript.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/typescript.html\r\n// Learn Attribute:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/reference/attributes.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/reference/attributes.html\r\n// Learn life-cycle callbacks:\r\n//  - [Chinese] http://docs.cocos.com/creator/manual/zh/scripting/life-cycle-callbacks.html\r\n//  - [English] http://www.cocos2d-x.org/docs/creator/manual/en/scripting/life-cycle-callbacks.html\r\n\r\n\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class NewClass extends cc.Component {\r\n    @property\r\n    game: any = null;\r\n\r\n    private currItemWrapper : any;\r\n    private currItemPosition : cc.Vec2;\r\n    private isMousedown = false;\r\n    private itemWrappers = [];\r\n    private gridGame = null;\r\n\r\n    onLoad() {\r\n        this.gridGame = this.game.getGridGameStruct();\r\n        this.gridGame.initBoard();\r\n        let gameBoard = this.gridGame.getGameBoard();\r\n        for(let row = 0; row < gameBoard.length; row++) {\r\n            for(let col = 0; col < gameBoard[row] .length;col++) {\r\n                let grid = gameBoard[row][col];\r\n                grid.setMoveCount( gameBoard.length - 1 );\r\n\r\n                let number = grid.getNumber();\r\n                let node = this.createItem( number, grid.getID() ); \r\n                node.zIndex = 0;\r\n                node.x = col * 100;\r\n                node.y = row * 100;\r\n                this.node.addChild(node);\r\n            }\r\n        }\r\n    }\r\n\r\n    private createItem(number : number, id: number) : cc.Node {\r\n        let itemWrapper = this.game.createItem( number ) as ItemWrapper;\r\n        itemWrapper.number = number;\r\n        itemWrapper.id = id;\r\n        this.itemWrappers.push(itemWrapper);\r\n        let node = itemWrapper.content as cc.Node; \r\n        node.anchorX = 0;\r\n        node.anchorY = 0;\r\n\r\n        node.on(cc.Node.EventType.MOUSE_DOWN, e => {\r\n            this.currItemWrapper = itemWrapper;\r\n            this.currItemPosition = new cc.Vec2(node.x, node.y);\r\n            this.isMousedown = true;\r\n        }, this);\r\n\r\n        node.on(cc.Node.EventType.MOUSE_MOVE, ( event: cc.Event.EventMouse ) => {\r\n            if( !this.isMousedown ) {\r\n                return;\r\n            }\r\n            var toPostion = this.node.convertToNodeSpaceAR(event.getLocation());\r\n            let fromNode = this.currItemWrapper.content as cc.Node;\r\n            fromNode.zIndex = 999;\r\n            fromNode.x = toPostion.x - fromNode.width / 2;\r\n            fromNode.y = toPostion.y - fromNode.height / 2;\r\n        }, this);\r\n\r\n        node.on(cc.Node.EventType.MOUSE_UP, ( event: cc.Event.EventMouse ) =>{\r\n            this.isMousedown = false;\r\n            let fromNode = this.currItemWrapper.content as cc.Node;\r\n            var postion = this.node.convertToNodeSpaceAR(event.getLocation());\r\n            let toNode = this.getTargetNode( event.target, postion );\r\n            if( toNode == null ) {\r\n                let fromNodeAct = cc.moveTo(0.1, this.currItemPosition);\r\n                fromNode.runAction(fromNodeAct);\r\n            } else {\r\n                let fromNodeAct = cc.moveTo( 0.1, toNode.x, toNode.y );\r\n                fromNode.runAction(fromNodeAct);\r\n                fromNode.zIndex = 0;\r\n                let toNodeAct = cc.moveTo(0.1, this.currItemPosition);\r\n                toNode.runAction(toNodeAct);\r\n                //执行逻辑交换\r\n                let fromWrapper = this.findItemWrapperByItem( fromNode );\r\n                let toWrapper = this.findItemWrapperByItem( toNode );\r\n                this.gridGame.swapGrid(fromWrapper.id, toWrapper.id);\r\n                var removeableGrids = this.gridGame.remove();\t\r\n                for(let i = 0; i < removeableGrids.length; i++) {\r\n                    let id = removeableGrids[i].getID();\r\n                    let removeableNode = this.findNodeById( id );\r\n                    this.node.removeChild(removeableNode);\r\n                    this.removeItemInItemWrappers(id);\r\n                }\r\n                this.fill();\r\n            }\r\n        }, this)\r\n\r\n        return node;\r\n    }\r\n\r\n    private removeItemInItemWrappers( id : number) {\r\n        this.itemWrappers = this.itemWrappers.filter( item => item.id != id );\r\n    }\r\n\r\n    private fill() {\r\n        this.gridGame.fillGameBoard();\r\n        let gameBoard = this.gridGame.getGameBoard();\r\n    \r\n        for(let row = 0; row < gameBoard.length; row++) {\r\n            for(let col = 0; col < gameBoard[row].length;col++) {\r\n                let grid = gameBoard[row][col];\r\n                if( grid.moveable() && !grid.isNew() ) {\r\n                    let node = this.findNodeById(grid.getID());\r\n                    if(node != null) {\r\n                        let x = node.x;\r\n                        let y = node.y -  node.height * grid.getMoveCount();\r\n                        let moveAct = cc.moveTo( 0.5, x, y );\r\n                        node.runAction( moveAct );\r\n                    }\r\n                } else if( grid.isNew() ) {\r\n                    let node = this.createItem(grid.getNumber(),grid.getID());\r\n                    node.zIndex = 0;\r\n\r\n                    let x = col * 100;\r\n                    let y = row * 100;\r\n\r\n                    node.x = x;\r\n                    node.y = gameBoard.length * 100;\r\n                    this.node.addChild( node );\r\n\r\n                    let moveAct = cc.moveTo( 0.5, x, y );\r\n                    node.runAction( moveAct );\r\n                }      \r\n            }\r\n        }\r\n    }\r\n\r\n    private getTargetNode(target: cc.Node, pos: cc.Vec2) : cc.Node {\r\n        for(let i = 0; i < this.itemWrappers.length; i++) {\r\n            let item = this.itemWrappers[i];\r\n            let itemNode = item.content;\r\n            let rect = new cc.Rect(itemNode.x,itemNode.y,itemNode.width,itemNode.height);\r\n            if( rect.contains( pos ) && target != itemNode) {\r\n                return itemNode;\r\n            }\r\n        }\r\n        return null;\r\n    }\r\n\r\n    private findItemWrapperByItem( item ) {\r\n        let resultItems = this.itemWrappers.filter( n => n.content == item );\r\n        if( resultItems.length > 0 ) {\r\n            return resultItems[0];\r\n        } else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    private findNodeById( id ) : cc.Node{\r\n        let resultItems = this.itemWrappers.filter( n =>n.id == id);\r\n        if( resultItems.length > 0 ) {\r\n            return resultItems[0].content;\r\n        }  else {\r\n            return null;\r\n        }\r\n    }\r\n\r\n    start() {\r\n\r\n    }\r\n\r\n    // update (dt) {}\r\n}\r\n"]}